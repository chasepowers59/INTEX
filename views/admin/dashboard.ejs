<%- include('../partials/header', { user: user }) %>

    <div class="container" style="padding: 4rem 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1>Admin Dashboard</h1>
            <div style="display: flex; gap: 1rem;">
                <a href="/participants" class="btn">Manage Participants</a>
                <a href="/events" class="btn">Manage Events</a>
            </div>
        </div>

        <!-- Analytics Placeholder -->
        <div id="tableau-dashboard"
            style="background: #f0f0f0; height: 300px; margin-bottom: 2rem; display: flex; align-items: center; justify-content: center; border: 2px dashed #ccc;">
            <p style="color: #888;">Tableau Analytics Dashboard Placeholder</p>
        </div>

        <!-- Filters -->
        <div class="card" style="margin-bottom: 2rem; padding: 1.5rem;">
            <h4 style="margin-bottom: 1rem;">Filters</h4>
            <form id="filterForm" action="/admin/dashboard" method="GET"
                style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <select name="eventType" class="form-control" style="width: auto;" onchange="this.form.submit()">
                    <option value="">All Event Types</option>
                    <% if (options && options.eventTypes) { %>
                        <% options.eventTypes.forEach(type=> { %>
                            <option value="<%= type %>" <%=filters.eventType===type ? 'selected' : '' %>><%= type %>
                            </option>
                            <% }) %>
                                <% } %>
                </select>
                <select name="city" class="form-control" style="width: auto;" onchange="this.form.submit()">
                    <option value="">All Cities</option>
                    <% if (options && options.cities) { %>
                        <% options.cities.forEach(city=> { %>
                            <option value="<%= city %>" <%=filters.city===city ? 'selected' : '' %>><%= city %>
                            </option>
                            <% }) %>
                                <% } %>
                </select>
                <select name="role" class="form-control" style="width: auto;" onchange="this.form.submit()">
                    <option value="">All Roles</option>
                    <% if (options && options.roles) { %>
                        <% options.roles.forEach(role=> { %>
                            <option value="<%= role %>" <%=filters.role===role ? 'selected' : '' %>><%= role %>
                            </option>
                            <% }) %>
                                <% } %>
                </select>
            </form>
        </div>

        <!-- KPI Cards -->
        <div class="grid-3" style="margin-bottom: 4rem;">
            <div class="card">
                <h3 style="font-size: 3rem; color: var(--col-blue);">
                    <%= kpis.totalParticipants %>
                </h3>
                <p>Total Participants</p>
            </div>
            <div class="card">
                <div class="card">
                    <h3>Event Satisfaction</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="satisfactionChart"
                            data-chart-data='<%- JSON.stringify(charts.satisfaction) %>'></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3>Participant Cities</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="cityChart" data-chart-data='<%- JSON.stringify(charts.city) %>'></canvas>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Satisfaction Chart
                const satisfactionCanvas = document.getElementById('satisfactionChart');
                if (satisfactionCanvas) {
                    const satisfactionCtx = satisfactionCanvas.getContext('2d');
                    const satisfactionData = JSON.parse(satisfactionCanvas.dataset.chartData);

                    new Chart(satisfactionCtx, {
                        type: 'bar',
                        data: {
                            labels: satisfactionData.map(d => d.event_type),
                            datasets: [{
                                label: 'Avg Satisfaction Score',
                                data: satisfactionData.map(d => d.avg_score),
                                backgroundColor: ['#99B7C6', '#978EC4', '#9AB59D'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, max: 5 }
                            }
                        }
                    });
                }

                // City Chart
                const cityCanvas = document.getElementById('cityChart');
                if (cityCanvas) {
                    const cityCtx = cityCanvas.getContext('2d');
                    const cityData = JSON.parse(cityCanvas.dataset.chartData);

                    new Chart(cityCtx, {
                        type: 'doughnut',
                        data: {
                            labels: cityData.map(d => d.participant_city || 'Unknown'),
                            datasets: [{
                                data: cityData.map(d => d.count),
                                backgroundColor: ['#FFD8D1', '#F9AFB1', '#F4B092', '#CE325B', '#9AB59D']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
            });
        </script>

        <%- include('../partials/footer') %>