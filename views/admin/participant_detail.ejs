<%- include('../partials/header', { user: user }) %>

    <div class="container">
        <!-- Header Section -->
        <div class="card"
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 1.5rem;">
                <!-- Photo Placeholder -->
                <div
                    style="width: 80px; height: 80px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #aaa;">
                    <i class="fas fa-user" style="font-size: 2rem;"></i>
                </div>
                <div>
                    <h1 style="margin-bottom: 0.5rem;">
                        <%= participant.first_name %>
                            <%= participant.last_name %>
                    </h1>
                    <span class="badge"
                        style="background: var(--btn-blue); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">
                        <%= participant.generation_status %> Generation
                    </span>
                </div>
            </div>
            <button class="btn">Edit Profile</button>
        </div>

        <div class="dashboard-grid">
            <!-- Left Column: Demographics & Contact -->
            <div class="left-col">
                <div class="card">
                    <h3 class="mb-4">Demographics</h3>
                    <div style="margin-bottom: 1rem;">
                        <p class="stat-label">Household Income</p>
                        <p><strong>
                                <%= participant.household_income_bracket || 'Not Provided' %>
                            </strong></p>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <p class="stat-label">Email</p>
                        <p><a href="mailto:<%= participant.email %>">
                                <%= participant.email %>
                            </a></p>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <p class="stat-label">Phone</p>
                        <p>
                            <%= participant.phone || 'N/A' %>
                        </p>
                    </div>
                </div>

                <div class="card">
                    <h3 class="mb-4">Quick Stats</h3>
                    <div style="display: flex; justify-content: space-between; text-align: center;">
                        <div>
                            <div class="stat-value">
                                <%= registrations.length %>
                            </div>
                            <div class="stat-label">Events</div>
                        </div>
                        <div>
                            <div class="stat-value">
                                <%= milestones.length %>
                            </div>
                            <div class="stat-label">Milestones</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center/Right Column: Timeline & History -->
            <div class="right-col">
                <!-- Events Timeline -->
                <div class="card">
                    <h3 class="mb-4">Events Attended</h3>
                    <% if (registrations.length> 0) { %>
                        <% registrations.forEach(reg=> { %>
                            <div class="timeline-item">
                                <h4>
                                    <%= reg.event_name %>
                                </h4>
                                <p style="color: #666; font-size: 0.9rem;">
                                    <%= reg.start_time ? new Date(reg.start_time).toLocaleDateString('en-US') : 'TBD' %> | <%= reg.event_type %>
                                </p>
                                <p style="margin-top: 0.5rem;">
                                    <%= reg.location %>
                                </p>
                            </div>
                            <% }) %>
                                <% } else { %>
                                    <p>No events attended yet.</p>
                                    <% } %>
                </div>

                <div class="grid grid-3" style="grid-template-columns: 1fr 1fr;">
                    <!-- Milestones -->
                    <div class="card">
                        <h3 class="mb-4">Milestones</h3>
                        <% if (milestones.length> 0) { %>
                            <ul style="list-style: none; padding: 0;">
                                <% milestones.forEach(m=> { %>
                                    <li
                                        style="margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">
                                        <strong>
                                            <%= m.title %>
                                        </strong><br>
                                        <small style="color: #666;">
                                            <%= m.date_achieved ? new Date(m.date_achieved).toLocaleDateString('en-US') : 'N/A' %>
                                        </small>
                                    </li>
                                    <% }) %>
                            </ul>
                            <% } else { %>
                                <p style="color: #888; font-style: italic;">No milestones recorded.</p>
                                <% } %>
                                    <a href="/admin/milestone/add" class="btn"
                                        style="margin-top: 1rem; font-size: 0.8rem; padding: 0.5rem 1rem;">+ Add
                                        Milestone</a>
                    </div>

                    <!-- Evolution (Survey History Chart) -->
                    <div class="card">
                        <h3 class="mb-4">Evolution</h3>
                        <canvas id="evolutionChart" height="200"></canvas>
                        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                        <script>
                            document.addEventListener('DOMContentLoaded', function () {
                                const ctx = document.getElementById('evolutionChart').getContext('2d');
                                const surveyData = <% - JSON.stringify(surveys) %>;

                                // Sort by date if needed, assuming survey_date exists or using index
                                const labels = surveyData.map((s, i) => `Survey ${i + 1}`);
                                const confidenceScores = surveyData.map(s => s.self_confidence_rating);
                                const satisfactionScores = surveyData.map(s => s.satisfaction_score);

                                new Chart(ctx, {
                                    type: 'line',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            label: 'Confidence',
                                            data: confidenceScores,
                                            borderColor: '#978EC4',
                                            tension: 0.4
                                        }, {
                                            label: 'Satisfaction',
                                            data: satisfactionScores,
                                            borderColor: '#94AAB9',
                                            tension: 0.4
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        scales: {
                                            y: { beginAtZero: true, max: 5 }
                                        }
                                    }
                                });
                            });
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>