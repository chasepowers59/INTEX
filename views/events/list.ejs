<%- include('../partials/header', { user: user }) %>

    <style>
        body {
            background-color: var(--col-cream);
        }
    </style>

    <!-- Banner Section with Wavy Edge -->
    <div class="wavy-banner">
        <h2>UPCOMING EVENTS</h2>
    </div>

    <div class="container" style="padding: 2rem 0 4rem 0; max-width: 1200px;">
        <!-- Search & Filter Card -->
        <div class="events-search-card">
            <form action="/events" method="GET" class="events-search-row">
                <input type="text" name="search" class="events-search-input" placeholder="Search events..." value="<%= search || '' %>">
                <button type="submit" class="events-search-btn">Search</button>
            </form>

            <% if (user && (user.participant_role === 'admin' || user.participant_role === 'manager')) { %>
                <div class="events-action-buttons">
                    <a href="/events/definitions/add" class="events-action-btn events-action-btn-purple">New Definition</a>
                    <a href="/events/add" class="events-action-btn events-action-btn-green">Schedule Event</a>
                </div>
            <% } %>
        </div>

        <!-- Events List -->
        <% 
            // Convert groupedEvents object to array for iteration
            const groupedEventsArray = groupedEvents ? Object.values(groupedEvents) : [];
        %>
        <% if (groupedEventsArray && groupedEventsArray.length > 0) { %>
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                <% groupedEventsArray.forEach(function(group) { %>
                    <div class="event-card-simple">
                        <div class="event-card-content">
                            <h3 class="event-card-title">
                                <%= group.definition.event_name %>
                            </h3>
                            <div class="event-card-meta">
                                <%= group.definition.event_type %>
                                <% if (group.definition.event_recurrence_pattern) { %>
                                    | <%= group.definition.event_recurrence_pattern %>
                                <% } %>
                            </div>
                            <p class="event-card-description">
                                <%= group.definition.event_description || 'Join us for this exciting event!' %>
                            </p>
                        </div>
                        <div class="event-card-action">
                            <button class="event-register-btn btn-toggle" data-event-id="<%= group.definition.event_name %>">
                                Select Date to Register (<%= group.instances.length %>)
                            </button>
                        </div>
                    </div>

                    <!-- Collapsible Instances List -->
                    <div class="instances-list" data-event-id="<%= group.definition.event_name %>"
                        style="display: none; background: white; border-radius: var(--radius-card); padding: 2rem; margin-bottom: 1.5rem; box-shadow: var(--shadow-soft);">
                        <p style="margin-bottom: 1.5rem; color: var(--col-blue); font-weight: 600; text-align: center; font-family: 'Montserrat', sans-serif;">
                            üëá Choose a specific date below to register:
                        </p>
                        <div class="grid-3" style="gap: 1rem;">
                            <% group.instances.forEach(function(event) { %>
                                <div style="background: var(--col-cream); padding: 1.5rem; border-radius: 15px; border: 1px solid rgba(148, 170, 185, 0.2);">
                                    <div style="margin-bottom: 0.75rem; font-weight: 600; color: var(--col-blue); font-family: 'Montserrat', sans-serif; font-size: 1rem;">
                                        <%= event.event_date_time_start ? new Date(event.event_date_time_start).toLocaleDateString('en-US', {
                                            weekday: 'short', month: 'short', day: 'numeric' }) : 'TBD' %>
                                    </div>
                                    <div style="margin-bottom: 0.75rem; font-size: 0.9rem; color: var(--text-light); font-family: 'Montserrat', sans-serif;">
                                        <%= event.event_date_time_start ? new Date(event.event_date_time_start).toLocaleTimeString('en-US', {
                                            hour: 'numeric', minute: '2-digit' }) : 'TBD' %>
                                        -
                                        <%= event.event_date_time_end ? new Date(event.event_date_time_end).toLocaleTimeString('en-US', {
                                            hour: 'numeric', minute: '2-digit' }) : 'TBD' %>
                                    </div>
                                    <div style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-light); font-family: 'Montserrat', sans-serif;">
                                        üìç <%= event.event_location || 'TBD' %> <br>
                                        üë• <%= event.event_capacity || 'Unlimited' %> spots
                                    </div>

                                    <% 
                                        // Business Logic: Determine what action buttons to show
                                        const now = new Date();
                                        let eventDate = null;
                                        if (event.event_date_time_start) {
                                            try {
                                                if (event.event_date_time_start instanceof Date) {
                                                    eventDate = event.event_date_time_start;
                                                } else {
                                                    eventDate = new Date(event.event_date_time_start);
                                                }
                                                if (isNaN(eventDate.getTime())) {
                                                    eventDate = null;
                                                }
                                            } catch (e) {
                                                eventDate = null;
                                            }
                                        }
                                        const eventTime = eventDate ? eventDate.getTime() : 0;
                                        const nowTime = now.getTime();
                                        const isPastEvent = eventDate && !isNaN(eventTime) && eventTime < nowTime;
                                        const registrationId = userRegistrations && userRegistrations[event.event_instance_id] ? userRegistrations[event.event_instance_id] : null;
                                        const hasSurvey = registrationId && userSurveys && userSurveys[registrationId];
                                        const isRegistered = !!registrationId;
                                    %>
                                    
                                    <% if (user) { %>
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                            <% if (user && (user.participant_role === 'admin' || user.participant_role === 'manager')) { %>
                                                <!-- Manager Actions: Always show Edit/Delete -->
                                                <div style="display: flex; gap: 0.5rem;">
                                                    <a href="/events/edit/<%= event.event_instance_id %>" class="btn"
                                                        style="padding: 0.4rem 0.8rem; font-size: 0.85rem; flex: 1; text-align: center; text-decoration: none;">Edit</a>
                                                    <form action="/events/delete/<%= event.event_instance_id %>"
                                                        method="POST" class="delete-event-form"
                                                        style="display: inline; flex: 1;">
                                                        <button type="submit" class="btn delete-event-btn"
                                                            style="padding: 0.4rem 0.8rem; font-size: 0.85rem; width: 100%; background-color: #dc3545; color: white; border: none;">Del</button>
                                                    </form>
                                                </div>
                                                <% if (isPastEvent && isRegistered && !hasSurvey) { %>
                                                    <a href="/surveys/new/<%= registrationId %>" class="btn"
                                                        style="width: 100%; padding: 0.5rem; font-size: 0.9rem; background-color: var(--col-blue); color: white; text-align: center; text-decoration: none;">
                                                        Submit Survey
                                                    </a>
                                                <% } else if (isPastEvent && isRegistered && hasSurvey) { %>
                                                    <div style="padding: 0.5rem; font-size: 0.85rem; color: #666; text-align: center; background: #f0f0f0; border-radius: 4px;">
                                                        Survey Submitted ‚úì
                                                    </div>
                                                <% } else if (isPastEvent) { %>
                                                    <div style="padding: 0.5rem; font-size: 0.85rem; color: #666; text-align: center; background: #f0f0f0; border-radius: 4px;">
                                                        Event Passed
                                                    </div>
                                                <% } else { %>
                                                    <% if (!isRegistered) { %>
                                                        <form action="/events/register/<%= event.event_instance_id %>" method="POST">
                                                            <button type="submit" class="btn"
                                                                style="width: 100%; padding: 0.5rem; font-size: 0.9rem; background-color: var(--col-green); color: white; border: none;">
                                                                Register for This Date
                                                            </button>
                                                        </form>
                                                    <% } else { %>
                                                        <div style="padding: 0.5rem; font-size: 0.85rem; color: var(--col-blue); text-align: center; background: #e8f4f8; border-radius: 4px; font-weight: 600;">
                                                            Registered ‚úì
                                                        </div>
                                                    <% } %>
                                                <% } %>
                                            <% } else { %>
                                                <!-- Common User Actions -->
                                                <% if (isPastEvent) { %>
                                                    <% if (isRegistered && !hasSurvey) { %>
                                                        <a href="/surveys/new/<%= registrationId %>" class="btn"
                                                            style="width: 100%; padding: 0.5rem; font-size: 0.9rem; background-color: var(--col-blue); color: white; text-align: center; text-decoration: none;">
                                                            Submit Survey
                                                        </a>
                                                    <% } else if (isRegistered && hasSurvey) { %>
                                                        <div style="padding: 0.5rem; font-size: 0.85rem; color: #666; text-align: center; background: #f0f0f0; border-radius: 4px;">
                                                            Survey Submitted ‚úì
                                                        </div>
                                                    <% } else { %>
                                                        <div style="padding: 0.5rem; font-size: 0.85rem; color: #666; text-align: center; background: #f0f0f0; border-radius: 4px;">
                                                            Event Passed
                                                        </div>
                                                    <% } %>
                                                <% } else { %>
                                                    <% if (!isRegistered) { %>
                                                        <form action="/events/register/<%= event.event_instance_id %>" method="POST">
                                                            <button type="submit" class="btn"
                                                                style="width: 100%; padding: 0.5rem; font-size: 0.9rem; background-color: var(--col-green); color: white; border: none;">
                                                                Register for This Date
                                                            </button>
                                                        </form>
                                                    <% } else { %>
                                                        <div style="padding: 0.5rem; font-size: 0.85rem; color: var(--col-blue); text-align: center; background: #e8f4f8; border-radius: 4px; font-weight: 600;">
                                                            Registered ‚úì
                                                        </div>
                                                    <% } %>
                                                <% } %>
                                            <% } %>
                                        </div>
                                    <% } else { %>
                                        <!-- Visitor Actions: Prompt to create account for future events -->
                                        <% if (isPastEvent) { %>
                                            <div style="padding: 0.5rem; font-size: 0.85rem; color: #666; text-align: center; background: #f0f0f0; border-radius: 4px;">
                                                Event Passed
                                            </div>
                                        <% } else { %>
                                            <a href="/auth/register" class="btn"
                                                style="width: 100%; padding: 0.5rem; font-size: 0.9rem; background-color: var(--col-green); text-align: center; text-decoration: none; display: block; color: white;">
                                                Create Account to Register
                                            </a>
                                        <% } %>
                                    <% } %>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <div class="text-center" style="padding: 4rem 0;">
                <p style="font-size: 1.2rem; color: var(--text-light); font-family: 'Montserrat', sans-serif;">No events found.</p>
            </div>
        <% } %>
    </div>

    <script>
        // Event Delegation: Handle all event interactions without inline handlers
        document.addEventListener('DOMContentLoaded', function () {
            // Toggle event instances when clicking register button
            document.addEventListener('click', function(e) {
                const registerBtn = e.target.closest('.btn-toggle');
                if (registerBtn) {
                    e.preventDefault();
                    const eventId = registerBtn.getAttribute('data-event-id');
                    const instancesList = document.querySelector(`.instances-list[data-event-id="${eventId}"]`);
                    
                    if (instancesList) {
                        if (instancesList.style.display === 'none' || !instancesList.style.display) {
                            instancesList.style.display = 'block';
                            registerBtn.textContent = 'Hide Dates';
                        } else {
                            instancesList.style.display = 'none';
                            const count = instancesList.querySelectorAll('.grid-3 > div').length;
                            registerBtn.textContent = `Select Date to Register (${count})`;
                        }
                    }
                }
            });

            // Delete event confirmation (without inline onsubmit)
            document.addEventListener('submit', function(e) {
                if (e.target && e.target.classList.contains('delete-event-form')) {
                    if (!confirm('Are you sure you want to delete this event?')) {
                        e.preventDefault();
                    }
                }
            });

            // Auto-expand if searching
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('search') || urlParams.has('eventType')) {
                const lists = document.querySelectorAll('.instances-list');
                const btns = document.querySelectorAll('.btn-toggle');

                lists.forEach(list => list.style.display = 'block');
                btns.forEach(btn => {
                    btn.textContent = 'Hide Dates';
                });
            }
        });
    </script>

    <%- include('../partials/footer') %>
