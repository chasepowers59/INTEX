<%- include('../partials/header', { user: user }) %>

    <div style="background-color: var(--col-blue); padding: 4rem 0; text-align: center; margin-bottom: 4rem;">
        <h1 style="color: white; font-size: 3rem; letter-spacing: 2px;">EVENTS</h1>
    </div>

    <div class="container" style="margin-bottom: 4rem;">
        <!-- Search Bar and Add Button -->
        <div
            style="display: flex; justify-content: space-between; align-items: center; max-width: 800px; margin: 0 auto 3rem auto;">
            <form action="/events" method="GET" style="flex-grow: 1; margin-right: 1rem;">
                <div style="display: flex; gap: 1rem;">
                    <input type="text" name="search" class="form-control" placeholder="Search events..."
                        value="<%= typeof search !== 'undefined' ? search : '' %>">
                    <button type="submit" class="btn">Search</button>
                </div>
            </form>
            <% if (user && user.role==='Manager' ) { %>
                <a href="/events/add" class="btn" style="background-color: var(--col-green);">+ Add Event</a>
                <% } %>
        </div>

        <% if (typeof groupedEvents !=='undefined' && groupedEvents && Object.keys(groupedEvents).length> 0) { %>
            <div style="display: flex; flex-direction: column; gap: 2rem;">
                <% Object.values(groupedEvents).forEach(function(group) { %>
                    <div class="card" style="text-align: left; padding: 0; overflow: hidden;">
                        <!-- Header / Definition Info -->
                        <div style="padding: 2rem; background: white; border-bottom: 1px solid #eee; cursor: pointer;"
                            onclick="toggleInstances(this)">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <h3 style="font-size: 1.8rem; margin-bottom: 0.5rem; color: var(--col-blue);">
                                        <%= group.definition.event_name %>
                                    </h3>
                                    <p style="color: var(--col-dark-pink); font-weight: 600; margin-bottom: 0.5rem;">
                                        <%= group.definition.event_type %>
                                            <% if (group.definition.event_recurrence_pattern) { %>
                                                | <%= group.definition.event_recurrence_pattern %>
                                                    <% } %>
                                    </p>
                                    <p style="color: #666; margin-bottom: 1rem; max-width: 800px;">
                                        <%= group.definition.event_description %>
                                    </p>
                                </div>
                                <button class="btn btn-toggle"
                                    style="background-color: var(--col-light-pink); color: var(--col-blue);">
                                    Select Date to Register (<%= group.instances.length %>)
                                </button>
                            </div>
                        </div>

                        <!-- Collapsible Instances List -->
                        <div class="instances-list"
                            style="display: none; background: #f9f9f9; padding: 1rem 2rem; max-height: 500px; overflow-y: auto;">
                            <p
                                style="margin-bottom: 1rem; color: var(--col-blue); font-weight: bold; text-align: center;">
                                üëá Choose a specific date below to register:</p>
                            <div class="grid-3" style="gap: 1rem;">
                                <% group.instances.forEach(function(event) { %>
                                    <div
                                        style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #ddd;">
                                        <div style="margin-bottom: 0.5rem; font-weight: bold; color: var(--col-blue);">
                                            <%= new Date(event.event_date_time_start).toLocaleDateString('en-US', {
                                                weekday: 'short' , month: 'short' , day: 'numeric' }) %>
                                        </div>
                                        <div style="margin-bottom: 0.5rem; font-size: 0.9rem;">
                                            <%= new Date(event.event_date_time_start).toLocaleTimeString('en-US', {
                                                hour: 'numeric' , minute: '2-digit' }) %>
                                                -
                                                <%= new Date(event.event_date_time_end).toLocaleTimeString('en-US', {
                                                    hour: 'numeric' , minute: '2-digit' }) %>
                                        </div>
                                        <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #666;">
                                            üìç <%= event.event_location %> <br>
                                                üë• <%= event.event_capacity %> spots
                                        </div>

                                        <% if (user) { %>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <% if (user.role==='Manager' ) { %>
                                                    <a href="/events/edit/<%= event.event_instance_id %>" class="btn"
                                                        style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">Edit</a>
                                                    <form action="/events/delete/<%= event.event_instance_id %>"
                                                        method="POST" onsubmit="return confirm('Are you sure?');"
                                                        style="display: inline;">
                                                        <button type="submit" class="btn"
                                                            style="padding: 0.3rem 0.8rem; font-size: 0.8rem; background-color: #dc3545;">Del</button>
                                                    </form>
                                                    <% } else { %>
                                                        <form action="/events/register/<%= event.event_instance_id %>"
                                                            method="POST">
                                                            <button type="submit" class="btn"
                                                                style="width: 100%; padding: 0.5rem; font-size: 0.9rem; background-color: var(--col-green);">Register
                                                                for This Date</button>
                                                        </form>
                                                        <% } %>
                                            </div>
                                            <% } else { %>
                                                <button onclick="openRegisterModal('<%= event.event_name %>')"
                                                    class="btn"
                                                    style="width: 100%; padding: 0.5rem; font-size: 0.9rem;">Register</button>
                                                <% } %>
                                    </div>
                                    <% }); %>
                            </div>
                        </div>
                    </div>
                    <% }); %>
            </div>
            <% } else { %>
                <div class="text-center">
                    <p>No events found.</p>
                </div>
                <% } %>

                    <!-- Registration Modal -->
                    <div id="registerModal"
                        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
                        <div
                            style="background: white; padding: 2rem; border-radius: 20px; max-width: 500px; width: 90%; position: relative;">
                            <span onclick="document.getElementById('registerModal').style.display='none'"
                                style="position: absolute; top: 1rem; right: 1.5rem; font-size: 1.5rem; cursor: pointer;">&times;</span>
                            <h2 style="margin-bottom: 1rem; color: var(--col-blue);">Register for Event</h2>
                            <p style="margin-bottom: 1.5rem; color: #666;">Please confirm your registration details
                                below.</p>
                            <form action="/contact" method="GET">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" class="form-control" placeholder="Your Name">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" class="form-control" placeholder="your@email.com">
                                </div>
                                <button type="submit" class="btn" style="width: 100%;">Confirm Registration</button>
                            </form>
                        </div>
                    </div>

                    <script>
                        function toggleInstances(element) {
                            // Handle both button click and header click
                            const card = element.closest('.card');
                            const list = card.querySelector('.instances-list');
                            const btn = card.querySelector('button.btn-toggle');

                            // Prevent double toggle if clicking button inside header
                            if (event.target !== element && event.target.tagName === 'BUTTON') {
                                // Let the button click handle it if we attached listener to button too? 
                                // Actually, if we click button, it bubbles to header. 
                                // But if we have onclick on button AND header, it might fire twice.
                                // The button in HTML does NOT have onclick now, only header has onclick.
                                // So clicking button bubbles to header. Perfect.
                            }

                            if (list.style.display === 'none') {
                                list.style.display = 'block';
                                if (btn) btn.textContent = 'Hide Dates';
                            } else {
                                list.style.display = 'none';
                                // Reset text
                                const count = list.querySelectorAll('.grid-3 > div').length;
                                if (btn) btn.textContent = `Select Date to Register (${count})`;
                            }
                        }

                        function openRegisterModal(eventName) {
                            const modal = document.getElementById('registerModal');
                            modal.style.display = 'flex';
                        }

                        // Close modal when clicking outside
                        window.onclick = function (event) {
                            const modal = document.getElementById('registerModal');
                            if (event.target == modal) {
                                modal.style.display = "none";
                            }
                        }

                        // Auto-expand if searching
                        document.addEventListener('DOMContentLoaded', function () {
                            const urlParams = new URLSearchParams(window.location.search);
                            if (urlParams.has('search')) {
                                const lists = document.querySelectorAll('.instances-list');
                                const btns = document.querySelectorAll('.card button.btn-toggle');

                                lists.forEach(list => list.style.display = 'block');
                                btns.forEach(btn => {
                                    btn.textContent = 'Hide Dates';
                                });
                            }
                        });
                    </script>

                    <%- include('../partials/footer') %>